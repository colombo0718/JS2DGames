<script src="https://unpkg.com/konva@4.0.0/konva.min.js"></script>
<div id="cont"></div>
<div id="scor">press "SPACE" to start</div> 
<script>
    // 建立舞台
    var stage = new Konva.Stage({
        container: 'cont',
        width: 400,
        height: 600
    });
    // 建立圖層
    var layer = new Konva.Layer();
    // 建立並加入草皮
    var turf = new Konva.Rect({
        width: 400,
        height: 600,
        fill: '#0a0'
    });
    layer.add(turf);
    // 建立並加入馬路
    var road = new Konva.Rect({
        x:50,
        width: 300,
        height: 600,
        fill: '#333'
    });
    layer.add(road);
    // 加入玩家的紅車車
    var redCar = new Konva.Rect({
        x:200,
        y:500,
        width: 30,
        height: 50,
        fill: '#f00'
    });
    layer.add(redCar);
    // 加入路人的藍車
    var bluCar = new Konva.Rect({
        x:200,
        y:0,
        width: 30,
        height: 50,
        fill: '#00f'
    });
    layer.add(bluCar);
    // 舞台中加入圖層
    stage.add(layer);
    // 汽車橫向平移
    var keyA,keyD
    // websocket
    // var ws = new WebSocket("ws://localhost:4200");
            
    // ws.onmessage=function(rtn){
    //     console.log(rtn.data)
    //     if(rtn.data=="D"){
    //         keyA=false
    //         keyD=false
    //         keyD=true
    //     }else if(rtn.data=="A"){
    //         keyA=false
    //         keyD=false
    //         keyA=true
    //     }
    // }
    var endgame=true

    setInterval(function(){
       
        if(!endgame){
            // 控制紅車
            if(keyD){redCar.x(redCar.x()+5)}
            if(keyA){redCar.x(redCar.x()-5)}

            // 藍車移動
            bluCar.y(bluCar.y()+5)
            if(bluCar.y()>600){
                bluCar.x(50+Math.random()*250)
                bluCar.y(-50)

                score+=1
                if(score==10){
                    score+=100
                    endgame=true
                }
                document.getElementById("scor").innerHTML="score="+score
            }
        
            // 傳給websocket server
            // console.log(redCar.x()+","+bluCar.x()+","+bluCar.y())
            // ws.send(redCar.x()+","+bluCar.x()+","+bluCar.y())

            // 進入草皮
            if(redCar.x()<50 || redCar.x()>320){
                console.log('gress')
                score-=100
                endgame=true
            }

            // 兩車碰撞
            if(Math.abs(redCar.x()-bluCar.x())<30 && 
            Math.abs(redCar.y()-bluCar.y())<50 ){
                console.log('collision')
                score-=100
                endgame=true
            }

            layer.draw()
        }
    },10)
    // 按鍵按下反應 
    document.addEventListener('keydown',function(event){
        if(endgame&&event.key==" "){
            endgame=false
            score=0
            redCar.x(200)
            bluCar.x(50+Math.random()*250)
            bluCar.y(-50)
            document.getElementById("scor").innerHTML="score="+score
        }
        if(event.key=="a"){keyA=true}
        if(event.key=="d"){keyD=true}   
    })
    document.addEventListener('keyup',function(event){
        if(event.key=="a"){keyA=false}
        if(event.key=="d"){keyD=false}   
    })

</script>

