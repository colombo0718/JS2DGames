<html>
<head>
<script src="https://unpkg.com/konva@4.0.0/konva.min.js"></script>
<style>
    #cont{
        height: 650px; width: 150px;
    }
    #info{
        font-size: 20;
        font-family:monospace;
        position: absolute;
        top:0px;left:150px;
        height: 650px; width: 250px;
    }
</style>
</head>
<body>
<div id="cont"></div>
<div id="info">
    [Infomation]<br>
    state:<text id='sta'>0</text><br>
    action:<text id='act'></text><br>
    reward:<text id='rew'>0</text><br>
    score:<text id='sco'>0</text><br>
    end:<text id='end'>false</text>
    </div>
<script>
    // [景物建置]
    var stage = new Konva.Stage({
        container: 'cont',
        width: 150,
        height: 600
    });
    var layer = new Konva.Layer();
    
    // 建立並加入草皮
    for(var j=1;j<12;j++){
        var rect = new Konva.Rect({
            x: 50,
            y: j*50,
            width: 50,
            height: 50, 
            fill: 'green',
            stroke: 'black',
            strokeWidth: 1,
        });
        layer.add(rect);
    }
    // 星星寶藏
    var star = new Konva.Star({
        x: 50+25,
        y: 50+25,
        numPoints: 6,
        innerRadius: 8,
        outerRadius: 14,
        fill: 'yellow',
        stroke: 'black',
        strokeWidth: 1,
    });
    layer.add(star);
    // 黑暗地洞
        var hole = new Konva.Rect({
        x: 50+10,
        y: 550+10,
        width: 30,
        height: 30,
        fill: 'gray',
        stroke: 'black',
        strokeWidth: 1,
    });
    layer.add(hole);
    // 加入人偶
    var man = new Konva.Group({
        x:50,y:300
    });
    // 人偶的頭
    var head = new Konva.Circle({
        x: 25,
        y: 12,
        radius: 7,
        fill: 'red',
        stroke: 'black',
        strokeWidth: 1,
    });
    man.add(head)
    // 人偶的身體
    var body = new Konva.Wedge({
        x: 25,
        y: 45,
        radius: 25,
        angle: 40,
        fill: 'red',
        stroke: 'black',
        strokeWidth: 1,
        rotation: -110,
    });
    man.add(body)
    layer.add(man);
    stage.add(layer);

    // [遊戲機制]
    var state='[0]',action,reward=0,score=0;end=true

    man.height=function(){
        return -1*(man.y()-300)/50
    }
    man.up=function(){
        action='w'
        man.y(man.y()-50)
    }
    man.down=function(){
        action='s'
        man.y(man.y()+50)
    }

    var updateInfo = function(){
        score+=reward
        state="["+man.height()+"]"
        state=man.height()
        document.getElementById('sta').innerHTML=state
        document.getElementById('act').innerHTML=action
        document.getElementById('rew').innerHTML=reward
        document.getElementById('sco').innerHTML=score
        document.getElementById('end').innerHTML=end
        reward=0
    }

    var resetGame=function(){
        action=" "
        score=0;end=false
        man.y(300)
    }

    document.addEventListener('keydown',function(event){
        // console.log(event.key)
        var key=event.key
        if(end=true && key==' '){
            ws.send(state)
            resetGame()
        }
        if(end==true){
            return 0
        } //遊戲停止就不能動了

        if(key=='w'){
            man.up()
            reward=-1
        }else if(key=='s'){
            man.down()
            reward=1
        }
        


        if(man.y()==550){reward=-10;end=true}
        if(man.y()==50){reward=10;end=true}
        updateInfo()
        stage.batchDraw()
    })

    // [後端控制]
    var ws = new WebSocket("ws://localhost:4300");
    // 
    ws.onopen=function(){
        console.log('open connection')
    }

    ws.onmessage=function(rtn){
        console.log(rtn.data)
        var key=rtn.data
        if(end==true && key==' '){
            state='end'
            resetGame()
        }
        if(end==true){return 0}

        if(key=='w'){
            man.up()
            reward=-1
        }else if(key=='s'){
            man.down()
            reward=1
        }

        if(man.y()==550){reward=-10;end=true;state="end"}
        if(man.y()==50){reward=10;end=true;state="end"}
        // console.log('sned')
        // setTimeout(function(){console.log(end,state);ws.send(state)},50)
        ws.send(state)
        updateInfo()
        stage.batchDraw()

    }
    

</script>
</body>
</html>